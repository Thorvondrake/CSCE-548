<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nocturne Archive | Management Portal</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; padding: 2rem; }
        .card { background: #1e293b; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        button { background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button:hover { background: #2563eb; }
        input { background: #334155; border: 1px solid #475569; color: white; padding: 0.75rem; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th { text-align: left; color: #94a3b8; border-bottom: 2px solid #334155; padding: 0.75rem; font-size: 0.875rem; }
        td { padding: 0.75rem; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Nocturne Archive Portal</h1>
        <p>Project 3 Client Interface</p>
        
        <div class="grid">
            <button onclick="fetchData('inventory')">Get All Records</button>
            <button onclick="fetchData('signed')">Get Signed Subset</button>
            <div style="display: flex; gap: 0.5rem;">
                <input type="number" id="bookId" placeholder="ID">
                <button onclick="fetchSingle()">Get Single</button>
            </div>
        </div>

        <table id="archiveTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Condition</th>
                    <th>Price</th>
                    <th>Signed</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const BASE_URL = "https://csce-548.onrender.com";

        // Updated function with proper error handling
        async function fetchData(endpoint) {
            console.log(`Making API call to: ${BASE_URL}/${endpoint}`);
            
            try {
                const response = await fetch(`${BASE_URL}/${endpoint}`, {
                    method: 'GET'
                });
                
                console.log(`Response status: ${response.status}`);
                console.log(`Response ok: ${response.ok}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Data received:", data);
                
                render(data);
                
            } catch (error) {
                console.error("API Call Error:", error);
                displayError(`Failed to fetch data: ${error.message}`);
            }
        }

        async function fetchSingle() {
            const id = document.getElementById('bookId').value;
            
            if (!id) {
                displayError("Please enter a book ID");
                return;
            }
            
            console.log(`Fetching single book with ID: ${id}`);
            
            try {
                const response = await fetch(`${BASE_URL}/inventory/${id}`, {
                    method: 'GET'
                });
                
                console.log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Single book data:", data);
                
                // Check if data is empty object (book not found)
                if (Object.keys(data).length === 0) {
                    displayError(`No book found with ID: ${id}`);
                    return;
                }
                
                render([data]); // Wrap in array for the renderer
                
            } catch (error) {
                console.error("Single book fetch error:", error);
                displayError(`Failed to fetch book: ${error.message}`);
            }
        }

        function render(data) {
            const body = document.getElementById('tableBody');
            
            if (!Array.isArray(data) || data.length === 0) {
                body.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }
            
            body.innerHTML = data.map(book => `
                <tr>
                    <td>${book.id || 'N/A'}</td>
                    <td>${book.title || 'N/A'}</td>
                    <td>${book.condition || 'N/A'}</td>
                    <td>$${book.price ? book.price.toFixed(2) : '0.00'}</td>
                    <td>${book.isSigned ? "Yes" : "No"}</td>
                </tr>
            `).join('');
        }

        function displayError(message) {
            const body = document.getElementById('tableBody');
            body.innerHTML = `<tr><td colspan="5" style="color: #ef4444; text-align: center;">${message}</td></tr>`;
        }

        // Test function to check if the API is reachable
        async function testConnection() {
            console.log("Testing connection to:", BASE_URL);
            try {
                const response = await fetch(BASE_URL, {
                    method: 'GET'
                });
                console.log("Connection test response:", response);
            } catch (error) {
                console.error("Connection test failed:", error);
            }
        }

        // Run connection test when page loads
        window.addEventListener('load', () => {
            console.log("Page loaded, testing API connection...");
            testConnection();
        });
    </script>
</body>
</html>